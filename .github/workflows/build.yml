# based on https://raw.githubusercontent.com/h2non/bimg/master/preinstall.sh

name: build
env:
  version: '8.10.5'
  debVersion: '+1'

on:
  push:
    branches: [ main ]

  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-18.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 1
      - name: Prepare template
        run: |
          dest=td-libvips-dev_${{env.version}}${{env.debVersion}}
          mkdir -p ${dest}
          cp -rv DEBIAN.template ${dest}/DEBIAN
          sed -i "s/%VERSION%/${{env.version}}/g" ${dest}/DEBIAN/*
          sed -i 's/%DEB_VERSION%/${{env.debVersion}}/g' ${dest}/DEBIAN/*
      - name: Download lib
        run: |
          dest=td-libvips-dev_${{env.version}}${{env.debVersion}}
          mkdir -p ${dest}/usr/local/src
          cd ${dest}/usr/local/src
          curl -L -o vips-${{env.version}}.tar.gz https://github.com/libvips/libvips/releases/download/v${{env.version}}/vips-${{env.version}}.tar.gz
          tar zvxf vips-${{env.version}}.tar.gz
          rm vips-${{env.version}}.tar.gz
          cd vips-%VERSION%
          CXXFLAGS="-D_GLIBCXX_USE_CXX11_ABI=0" ./configure \
              --disable-debug \
              --disable-static \
              --disable-introspection \
              --disable-dependency-tracking \
              --without-python \
              --without-orc \
              --without-fftw
          make
      - name: Build .deb
        run: |
          dest=td-libvips-dev_${{env.version}}${{env.debVersion}}
          dpkg-deb --build ${dest}
          mkdir -p dist
          mv ${dest}.deb dist
      - name: Try install
        working-directory: dist
        run: |
          dest=td-libvips-dev_${{env.version}}${{env.debVersion}}
          sudo apt-get install -y cmake giflib-tools gobject-introspection gtk-doc-tools libgif-dev libgsf-1-dev libpoppler-glib-dev libwebp-dev
          sudo dpkg -i ${dest}.deb
      - name: Install SSH Client
        uses: webfactory/ssh-agent@v0.4.1
        with:
          ssh-private-key: ${{ secrets.DEPLOY_KEY }}
      - name: Deploy
        uses: JamesIves/github-pages-deploy-action@3.7.1
        with:
          REPOSITORY_NAME: tada-team/ppa
          TARGET_FOLDER: td-libvips-dev-dist
          FOLDER: dist
          SSH: true
          BRANCH: main
